# Run integration tests with this Makefile.
#
# Usage:
# 	make [target]
#
# where target is one of: all, smiv, monolithic, composable.

.PHONY: tests build smiv monolithic composable

smiv: 			ARCH=SMIV
smv: 			  ARCH=SMV
monolithic: ARCH=MONOLITHIC
composable: ARCH=COMPOSABLE
eigen:      ARCH=EIGEN
mkl:        ARCH=MKLDNN

# The 'all' target must be written like this so that each build gets cleaned
# before each test.
all:
	@$(MAKE) -C . --no-print-directory monolithic
	@$(MAKE) -C . --no-print-directory composable
	@$(MAKE) -C . --no-print-directory smiv
	@$(MAKE) -C . --no-print-directory smv
#	@$(MAKE) -C . --no-print-directory eigen
	@$(MAKE) -C . --no-print-directory mkl

build:
	@echo "Building test..."
	@$(MAKE) -C .. --no-print-directory clean-native
	@$(MAKE) -C .. --no-print-directory native ARCH=$(ARCH)

smiv: build
	@python run_tests.py smiv ../build/nnet-smiv-native

smv: build
	@python run_tests.py smv ../build/nnet-smv-native

monolithic: build
	@python run_tests.py monolithic ../build/nnet-monolithic-native

composable: build
	@python run_tests.py composable ../build/nnet-composable-native

eigen:
	@$(MAKE) -C .. --no-print-directory clean-eigen
	@$(MAKE) -C .. --no-print-directory eigen ARCH=$(ARCH)
	@python run_tests.py eigen ../build/nnet-eigen-native

mkl:
	@$(MAKE) -C .. --no-print-directory clean-mkl
	@$(MAKE) -C .. --no-print-directory mkl ARCH=$(ARCH)
	@python run_tests.py mkl ../build/nnet-mkl-native
